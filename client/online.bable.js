'use strict';var _createClass=function(){function a(b,c){for(var f,d=0;d<c.length;d++)f=c[d],f.enumerable=f.enumerable||!1,f.configurable=!0,'value'in f&&(f.writable=!0),Object.defineProperty(b,f.key,f)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')}(function(){function a(){return(0|999999999999999*Math.random()).toString(32)}(function(){function c(d){var h=this;if(_classCallCheck(this,c),this.addr=d,this.groups=new Set,this.on=!1,this.onOnlineChange=null,this.pinger=setInterval(function(){h.opened&&h.ws.send('')},2e4),this.user=Date.now().toString(32)+'-'+a(),window.sessionStorage){var f=sessionStorage.getItem('online_user');f?this.user=f:sessionStorage.setItem('online_user',this.user)}d&&(this.on=!0,this.connet())}return _createClass(c,[{key:'enter',value:function enter(d){if('string'!=typeof d)throw'name is not a string:'+d;return this.groups.add(d),this.opened&&this.ws.send(JSON.stringify({_:'enter',g:d,u:this.user})),this}},{key:'leave',value:function leave(d){if('string'!=typeof d)throw'name is not a string:'+d;return this.opened&&this.groups.delete(d)&&this.ws.send(JSON.stringify({_:'leave',g:d})),this}},{key:'leaveAll',value:function leaveAll(){if(this.opened){var j=!0,k=!1,l=void 0;try{for(var f,n,d=this.groups[Symbol.iterator]();!(j=(f=d.next()).done);j=!0)n=f.value,this.leave(n)}catch(n){k=!0,l=n}finally{try{!j&&d.return&&d.return()}finally{if(k)throw l}}}return this}},{key:'_report',value:function _report(){this.onOnlineChange&&this.onOnlineChange(group,ol)}},{key:'connet',value:function connet(d){var h=this;if((d&&(this.addr=d),!1!==this.on)&&!this.opened){var f=this.ws=new WebSocket(this.addr);return f.onmessage=function(j){if('connected'===j.data){var _iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var l,n,k=h.groups[Symbol.iterator]();!(_iteratorNormalCompletion2=(l=k.next()).done);_iteratorNormalCompletion2=!0)n=l.value,h.enter(n)}catch(p){_didIteratorError2=!0,_iteratorError2=p}finally{try{!_iteratorNormalCompletion2&&k.return&&k.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return}var o=JSON.parse(j.data);switch(o._){case'ol':{o.c=parseInt(o.c,32),o.u=parseInt(o.u,32),h._report(o);break}}},f.onclose=function(){var _iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var l,n,k=h.groups[Symbol.iterator]();!(_iteratorNormalCompletion3=(l=k.next()).done);_iteratorNormalCompletion3=!0)n=l.value,h._report({g:n,c:0,u:0})}catch(o){_didIteratorError3=!0,_iteratorError3=o}finally{try{!_iteratorNormalCompletion3&&k.return&&k.return()}finally{if(_didIteratorError3)throw _iteratorError3}}setTimeout(function(){h.connet()},5e3)},this}}},{key:'close',value:function close(){this.on=!1,this.ws.close(),clearInterval(this.pinger)}},{key:'opened',get:function get(){return this.ws&&1===this.ws.readyState}}]),c})()})();